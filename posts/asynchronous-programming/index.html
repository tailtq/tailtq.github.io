<!DOCTYPE html><html lang="en-US" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Asynchronous Programming" /><meta name="author" content="Tai Le" /><meta property="og:locale" content="en_US" /><meta name="description" content="A minimal, portfolio, sidebar, bootstrap Jekyll theme with responsive web design and focuses on text presentation." /><meta property="og:description" content="A minimal, portfolio, sidebar, bootstrap Jekyll theme with responsive web design and focuses on text presentation." /><link rel="canonical" href="https://tailtq.github.io/posts/asynchronous-programming/" /><meta property="og:url" content="https://tailtq.github.io/posts/asynchronous-programming/" /><meta property="og:site_name" content="Tailtq" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-03-19T00:00:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Asynchronous Programming" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Tai Le" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Tai Le"},"dateModified":"2023-03-25T23:53:15+07:00","datePublished":"2023-03-19T00:00:00+07:00","description":"A minimal, portfolio, sidebar, bootstrap Jekyll theme with responsive web design and focuses on text presentation.","headline":"Asynchronous Programming","mainEntityOfPage":{"@type":"WebPage","@id":"https://tailtq.github.io/posts/asynchronous-programming/"},"url":"https://tailtq.github.io/posts/asynchronous-programming/"}</script><title>Asynchronous Programming | Tailtq</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Tailtq"><meta name="application-name" content="Tailtq"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-ZB7VQFD7XK"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-ZB7VQFD7XK'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-right"><div id="avatar"> <a href="/" alt="avatar"> <img src="/assets/img/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Tailtq</a></div><div class="site-subtitle">A software developer who enjoys learning, reading, and building things</div></div><hr><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <span>Home</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <span>About me</span> </a><li class="nav-item"> <a href="/interesting-blogs/" class="nav-link"> <span>Interesting blogs</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <span>Archives</span> </a><li class="nav-item"> <a href="https://github.com/tailtq" class="nav-link" target="_blank"> <span>GitHub</span> </a><li class="nav-item}"> <a href="https://www.linkedin.com/in/tai-le-05124a187/" class="nav-link" target="_blank"> <span>Linkedin</span> </a></ul></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Asynchronous Programming</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Asynchronous Programming</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Tai Le </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Mar 19, 2023, 12:00 AM +0700" prep="on" > Mar 19 <i class="unloaded">2023-03-19T00:00:00+07:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Mar 25, 2023, 11:53 PM +0700" prefix="Updated " > Mar 25 <i class="unloaded">2023-03-25T23:53:15+07:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2000 words">11 min</span></div></div><div class="post-content"><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2023-03-19/asyncio-header.png" alt="Untitled" /></p><p>It has been a long time since I wrote my last post. To be honest, I have been quite lazy since Tet holiday and lacked the motivation to complete personal tasks. I‚Äôm still in my own head a lot üòÇ.</p><p>Fortunately, I have made up my mind to continue learning and sharing, and the topic today is <strong>Asynchronous Programming in Python</strong>. This topic became popular with the release of NodeJS and many languages have tried to apply this feature. It is also one of the foremost concepts in server-side development that our engineers need to understand.</p><p>Please enjoy and provide feedback <em>(to my email)</em> if there are any mistakes in the post, thanks.</p><h2 id="asynchronous-programming">Asynchronous Programming</h2><p>Before tackling this concept, we should have a solid understanding of synchronous programming. <strong>Synchronous programming</strong> is the traditional way in which instructions are executed, from top to bottom, and each instruction must be done before running the next.</p><p>For example, if we are building a crawler and it needs to crawl 3 sites, we need to execute 3 request calls sequentially like the code below:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">requests</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s">"https://site1.com"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Content of site 1: </span><span class="si">{</span><span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s">"https://site2.com"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Content of site 2: </span><span class="si">{</span><span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s">"https://site3.com"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Content of site 3: </span><span class="si">{</span><span class="n">res</span><span class="p">.</span><span class="n">content</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</pre></table></code></div></div><p>By using synchronous programming, the third request only executes after the second request is done, and the second request only executes after the first request is done. Assuming each request takes 3 seconds to complete, the process runs in 9 seconds.</p><p>This whole process causes slowness because it depends on the third parties; if the third party is slower, the process will wait longer. It‚Äôs ideal if 3 requests could execute simultaneously and return the response at once because the requests don‚Äôt rely on each other. Here‚Äôs where asynchronous programming comes in handy.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2023-03-19/sync-async-requests.png" alt="Untitled" /></p><p>Instead of waiting to return the response directly, asynchronous I/O delays the execution and returns a <strong>Future</strong> (Python)/<strong>Promise</strong> (JavaScript) as an execution proof without blocking the thread and continuing to invoke other requests. To be clear, asynchrony still goes through the instructions from top to bottom, it just delays the execution and returns another form of the result directly.</p><p>In the example, after sending all requests, these Futures will be constantly checked until the responses are available. As you can imagine, 3 crawling requests run simultaneously without waiting for one after another. So the whole process only takes around 3 seconds to complete, which is 3 times faster.</p><p>But does this sound familiar with threading? Don‚Äôt worry, we will go through how it runs and compare them in the next section.</p><h2 id="asynchronous-programming-in-python">Asynchronous Programming in Python</h2><p>Python began supporting asynchronous programming a long time ago with <code class="language-plaintext highlighter-rouge">gevent</code>, in version 3.4 which first introduced the Asyncio package - the core for asynchronous programming - and version 3.5 introduced <code class="language-plaintext highlighter-rouge">async/await</code> keywords.</p><p><em>Note: Async I/O is different from the Asyncio package. The package supports running Async I/O in Python.</em></p><p>Async I/O is a single-threaded and single-process design. It uses cooperative multitasking to handle a large number of I/O operations like database queries and third-party requests. This design boosts the performance of handling I/O operations significantly, which is very relevant in this era where many computational-intensive tasks are handled by service providers effectively.</p><h3 id="coroutinefuturetask">Coroutine/Future/Task</h3><p>Async I/O begins with defining <code class="language-plaintext highlighter-rouge">async</code> functions. Each function defined with the <code class="language-plaintext highlighter-rouge">async</code> keyword is called a <strong>coroutine</strong>; when the coroutine executes, it returns a <strong>future</strong> representing the eventual result of an asynchronous operation.</p><blockquote><p>Coroutines are a more generalized form of subroutines. Subroutines are entered at one point and exited at another point. Coroutines can be entered, exited, and resumed at many different points. ‚Äî (Python Glossary)</p></blockquote><p>This whole process is running in the Event Loop, which we will address later, where coroutines are executed using <strong>tasks.</strong> A Task, to be specific, is a sub-class of Future that runs a Python coroutine.</p><p><strong>Asynchronous I/O Flow:</strong> When executing a long-running coroutine, Python first creates a task and runs the coroutine within the task in the context of the Event Loop. In the document of Python, it says: ‚ÄúIf a coroutine awaits on a Future, the Task suspends the execution of the coroutine and waits for the completion of the Future. When the Future is¬†<em>done</em>, the execution of the wrapped coroutine resumes (<strong>callback</strong>)‚Äù (‚ÄúAsyncIO Task‚Äù, n.d.).</p><h3 id="event-loop">Event Loop</h3><p>As I mentioned above, an Event Loop is where all of the work happens. It can also be called the core of asynchronous operations in every asynchronous platform.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2023-03-19/event-loop2.jpg" alt="event_loop2.webp" /></p><p>When a Task is registered (executed), it will be put into a <strong>Task Queue</strong>, the loop will traverse through each item and execute them one at a time. While the Task awaits the completion of a Future (using <code class="language-plaintext highlighter-rouge">await</code> keyword), the loop runs other Tasks, callbacks, or performs I/O operations (‚ÄúCoroutine and Tasks‚Äù).</p><p><em>Note: The Event Loop runs on the main thread and executes Tasks sequentially.</em></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2023-03-19/event-loop1.jpg" alt="event_loop1.webp" /></p><p><strong>Questions:</strong></p><ul><li><strong>If the coroutine is CPU-bound and computationally expensive, will it block the Event Loop in Python?</strong></ul><p>‚áí Yes, it will block the Event Loop running in the main thread. If you define a coroutine and specify some heavy-lifting instructions, this means these instructions will run directly by the Event Loop. It will take time until other tasks get processed.</p><p>‚áí Blocking the Event Loop should be avoided because it hurts the performance and decreases the throughput of the system.</p><ul><li><strong>Where should the CPU-intensive Tasks be handled?</strong></ul><p>‚áí It is recommended to run these Tasks in a <code class="language-plaintext highlighter-rouge">ThreadPool</code> or a <code class="language-plaintext highlighter-rouge">ProcessPool</code> instead of the main thread. This is better because <code class="language-plaintext highlighter-rouge">ProcessPool</code> has many workers which can use multiple CPU cores instead of one.</p><h3 id="asyncio-package">Asyncio package</h3><p>Let‚Äôs test the Asyncio package a bit because this is the heart of asynchronous programming in Python.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">from</span> <span class="n">asyncio</span> <span class="kn">import</span> <span class="n">events</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

<span class="c1"># check if a function is a coroutine
</span><span class="nf">print</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">iscoroutinefunction</span><span class="p">(</span><span class="n">test</span><span class="p">))</span>

<span class="c1"># run the coroutine. Behind the scene, it creates a new event loop,
# then wraps the coroutine with a task and executes it.
</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">test</span><span class="p">())</span>

<span class="c1"># asyncio.run behind the scene.
# 1. Create a new event loop
# 2. Run the coroutine
</span><span class="n">event_loop</span> <span class="o">=</span> <span class="n">events</span><span class="p">.</span><span class="nf">new_event_loop</span><span class="p">()</span>
<span class="n">event_loop</span><span class="p">.</span><span class="nf">run_until_complete</span><span class="p">(</span><span class="nf">test</span><span class="p">())</span>
</pre></table></code></div></div><p>We can also run a coroutine in the background before actually awaiting it. Calling a coroutine alone is not enough because a warning is shown immediately <code class="language-plaintext highlighter-rouge">RuntimeWarning: coroutine 'test' was never awaited</code>. As you can see below, the Task is already finished even before awaiting it. It also doesn‚Äôt show any warning.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">test2</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="mi">123123</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">test2</span><span class="p">())</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">task</span>

<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">test</span><span class="p">())</span>
<span class="c1"># 123123
# &lt;Task finished name='Task-2' coro=&lt;test2() done, defined at test_asyncio.py:6&gt; result=None&gt;
</span></pre></table></code></div></div><p>Demo the example above a little bit. There are two versions, the <code class="language-plaintext highlighter-rouge">grequests</code> package uses Gevent and the <code class="language-plaintext highlighter-rouge">aiohttp</code> package uses Asyncio (They are packages supporting asynchrony). I recommend using <code class="language-plaintext highlighter-rouge">aiohttp</code> to better adapt Python‚Äôs newer versions.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">aiohttp</span>
<span class="kn">import</span> <span class="n">grequests</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="k">def</span> <span class="nf">run_synchronous_code</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">res1</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s">"http://httpbin.org/delay/3"</span><span class="p">)</span>
    <span class="n">res</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">res1</span><span class="p">)</span>
    <span class="n">res2</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s">"http://httpbin.org/delay/3"</span><span class="p">)</span>
    <span class="n">res</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">res2</span><span class="p">)</span>
    <span class="n">res3</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s">"http://httpbin.org/delay/3"</span><span class="p">)</span>
    <span class="n">res</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">res3</span><span class="p">)</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"End:"</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"Average response time:"</span><span class="p">,</span> <span class="n">end_time</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">run_asynchronous_code_gevent</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">"http://httpbin.org/delay/3"</span><span class="p">,</span>
        <span class="s">"http://httpbin.org/delay/3"</span><span class="p">,</span>
        <span class="s">"http://httpbin.org/delay/3"</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">grequests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">grequests</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"run_asynchronous_code_gevent"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"End:"</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">res</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">res</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_asynchronous_code_asyncio</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">"http://httpbin.org/delay/3"</span><span class="p">,</span>
        <span class="s">"http://httpbin.org/delay/3"</span><span class="p">,</span>
        <span class="s">"http://httpbin.org/delay/3"</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="p">.</span><span class="nc">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
				<span class="c1"># run multiple requests simutaneously
</span>        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nf">fetch</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">],</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"run_asynchronous_code_asyncio"</span><span class="p">)</span>
        <span class="c1"># print(res)
</span>        <span class="nf">print</span><span class="p">(</span><span class="s">"End:"</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

<span class="nf">run_synchronous_code</span><span class="p">()</span>
<span class="nf">print</span><span class="p">()</span>
<span class="nf">run_asynchronous_code_gevent</span><span class="p">()</span>
<span class="nf">print</span><span class="p">()</span>
<span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">run_asynchronous_code_asyncio</span><span class="p">())</span>

<span class="c1"># run_synchronous_code
# [&lt;Response [200]&gt;, &lt;Response [200]&gt;, &lt;Response [200]&gt;]
# End: 11.448019981384277
# Average response time: 3.816006660461426
#
# run_asynchronous_code_gevent
# [&lt;Response [200]&gt;, &lt;Response [200]&gt;, &lt;Response [200]&gt;]
# End: 4.113437175750732
#
# run_asynchronous_code_asyncio
# End: 4.878862142562866
</span></pre></table></code></div></div><h2 id="comparison-with-other-approaches">Comparison with other approaches</h2><p>Comparison is the best way to understand which tool to use in which circumstances, so we will compare 3 concepts: Coroutines, Threads, and Processes.</p><div class="table-wrapper"><table><thead><tr><th>¬†<th>Coroutine<th>Thread<th>Process<tbody><tr><td>Race conditions<td>Without context switches, it‚Äôs less likely to happen because the Event Loop is single-threaded and tasks are executed sequentially.<br /> But it still happens in some cases when memory is shared between coroutines.<td>Very likely to happen because context switches are mainly used to run threads concurrently.<td>Don‚Äôt happen because processes don‚Äôt use shared memory<tr><td>Creation speed (1.000.000 items - code below)<td>Fastest (7s)<td>Slow (44s)<td>Slowest (379s)<tr><td>Memory overhead (1.000.000 items)<td>1112 MB<td>2660 MB<td>Unable to calculate because processes use different memory spaces.<tr><td>Ease of Use and Debug<td>Easy by having shared memory and just a few race conditions.<td>Hard because of using locking mechanisms to prevent unexpected cases.<td>Hard because of not having a shared memory.<tr><td>Scheduling<td>By the application (manageable)<td>By the OS<td>By the OS<tr><td>Computational capacity (CPU-intensive tasks)<td>Low-Medium because the Event Loop only uses 1 CPU<td>Low-Medium because of Global Interpreter Lock (can only execute one thread at a time using 1 CPU)<td>Medium-High because of using multiple CPUs</table></div><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre><td class="rouge-code"><pre><span class="c1"># code for measuring time and memory usage
</span><span class="kn">import</span> <span class="n">multiprocessing</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">psutil</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="p">...</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">test2</span><span class="p">():</span>
    <span class="p">...</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">new_event_loop</span><span class="p">()</span>
<span class="n">asyncio</span><span class="p">.</span><span class="nf">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">mem_before</span> <span class="o">=</span> <span class="n">psutil</span><span class="p">.</span><span class="nc">Process</span><span class="p">().</span><span class="nf">memory_info</span><span class="p">().</span><span class="n">rss</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="n">coroutines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
        <span class="n">coroutines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">test2</span><span class="p">()))</span>
    <span class="n">mem_after</span> <span class="o">=</span> <span class="n">psutil</span><span class="p">.</span><span class="nc">Process</span><span class="p">().</span><span class="nf">memory_info</span><span class="p">().</span><span class="n">rss</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"Async I/O time:"</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"Memory consumption: %0.2fMB"</span> <span class="o">%</span> <span class="p">((</span><span class="n">mem_after</span> <span class="o">-</span> <span class="n">mem_before</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">))</span>

<span class="n">loop</span><span class="p">.</span><span class="nf">run_until_complete</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
<span class="c1"># Async I/O time: 6.777068614959717
# Memory consumption: 1111.67MB
</span>
<span class="n">mem_before</span> <span class="o">=</span> <span class="n">psutil</span><span class="p">.</span><span class="nc">Process</span><span class="p">().</span><span class="nf">memory_info</span><span class="p">().</span><span class="n">rss</span>
<span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
    <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">test</span><span class="p">)</span>
    <span class="n">thread</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
		<span class="n">threads</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="s">"Thread time:"</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
<span class="n">mem_after</span> <span class="o">=</span> <span class="n">psutil</span><span class="p">.</span><span class="nc">Process</span><span class="p">().</span><span class="nf">memory_info</span><span class="p">().</span><span class="n">rss</span>
<span class="nf">print</span><span class="p">(</span><span class="s">"Memory consumption: %0.2fMB"</span> <span class="o">%</span> <span class="p">((</span><span class="n">mem_after</span> <span class="o">-</span> <span class="n">mem_before</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">))</span>
<span class="c1"># Thread time: 43.58382987976074
# Memory consumption: 2660.73MB
</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">process</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="p">.</span><span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">test</span><span class="p">)</span>
    <span class="n">process</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="s">"Process time:"</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
<span class="c1"># Process time: 0.37912821769714355
# With 1.000.000 processes, it would take 379s.
</span></pre></table></code></div></div><p>As you can see, using asynchrony will benefit the system in multiple aspects, such as saving resources and increasing the system‚Äôs throughput. Besides, to me and other Python developers who have used synchronous programming for years, one disadvantage is the syntax; it‚Äôs quite challenging to use the <code class="language-plaintext highlighter-rouge">asyncio</code> library, but it‚Äôs an interesting process.</p><h2 id="conclusion">Conclusion</h2><p>After the post, will you still stick with threads and processes or use coroutines? Personally, it depends on the situation that we face. If the task is computationally expensive, using coroutines is not the right approach.</p><p>Anyway, hope you enjoy this post, please don‚Äôt forget to send me feedback if anything in this content is incorrect or bugs you so much. I will try my best to write more blog posts like this in the future.</p><h2 id="references">References</h2><ul><li>Brownlee. J. (2022). <em>Multiprocessing Race Conditions in Python. SuperFastPython</em>. <a href="https://superfastpython.com/multiprocessing-race-condition-python">https://superfastpython.com/multiprocessing-race-condition-python</a><li>Castelino. L. (2021). <em>Build Your Own Event Loop from Scratch in Python</em>. Medium. <a href="https://python.plainenglish.io/build-your-own-event-loop-from-scratch-in-python-da77ef1e3c39">https://python.plainenglish.io/build-your-own-event-loop-from-scratch-in-python-da77ef1e3c39</a><li>Coroutines and Tasks: <a href="https://docs.python.org/3/library/asyncio-task.html">https://docs.python.org/3/library/asyncio-task.html</a><li>Don‚Äôt Block the Event Loop (or the Worker Pool): <a href="https://nodejs.org/en/docs/guides/dont-block-the-event-loop/">https://nodejs.org/en/docs/guides/dont-block-the-event-loop/</a><li>Event Loop: <a href="https://docs.python.org/3/library/asyncio-eventloop.html">https://docs.python.org/3/library/asyncio-eventloop.html</a><li>Luminousmen. (n. d.) Asynchronous programming. Await the Future. <a href="https://luminousmen.com/post/asynchronous-programming-await-the-future">https://luminousmen.com/post/asynchronous-programming-await-the-future</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/python/" class="post-tag no-text-decoration" >Python</a> <a href="/tags/back-end/" class="post-tag no-text-decoration" >Back-end</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Asynchronous Programming - Tailtq&url=https://tailtq.github.io/posts/asynchronous-programming/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Asynchronous Programming - Tailtq&u=https://tailtq.github.io/posts/asynchronous-programming/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Asynchronous Programming - Tailtq&url=https://tailtq.github.io/posts/asynchronous-programming/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/asynchronous-programming/">Asynchronous Programming</a><li><a href="/posts/streamlit-a-fast-way-to-build-web-applications/">Streamlit - A Fast Way to Build Web Applications</a><li><a href="/posts/modify-facebook-duckling/">Modify Facebook's Duckling</a><li><a href="/posts/tensorflow-with-amd-ubuntu/">Use Tensorflow with AMD GPU on Ubuntu</a><li><a href="/posts/how-i-reduced-rasa-testing-time-by-60-80/">How I reduced RASA testing time by 60-80%</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/ai/">AI</a> <a class="post-tag" href="/tags/back-end/">Back-end</a> <a class="post-tag" href="/tags/database/">Database</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/front-end/">Front-end</a> <a class="post-tag" href="/tags/haskell/">Haskell</a> <a class="post-tag" href="/tags/math/">Math</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/tensorflow/">Tensorflow</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/multithreading-vs-multiprocessing/"><div class="card-body"> <span class="timeago small" > Apr 2, 2022 <i class="unloaded">2022-04-02T00:00:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Multi-threading vs Multi-processing</h3><div class="text-muted small"><p> At some points, we encounter some problems that make our applications tremendously slow. It could be the amount of computation is large, or accessing multiple resources at the time, or too many tas...</p></div></div></a></div><div class="card"> <a href="/posts/caching/"><div class="card-body"> <span class="timeago small" > May 1, 2022 <i class="unloaded">2022-05-01T00:00:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Caching</h3><div class="text-muted small"><p> With an anxious feeling at this moment, I have decided to write a blog article to relieve that feeling. Again, it is all about summarizing things that I have recently worked on, this time is some c...</p></div></div></a></div><div class="card"> <a href="/posts/how-i-reduced-rasa-testing-time-by-60-80/"><div class="card-body"> <span class="timeago small" > Aug 6, 2022 <i class="unloaded">2022-08-06T00:00:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How I reduced RASA testing time by 60-80%</h3><div class="text-muted small"><p> It is quite a long time since I wrote my latest post, and now I come back stronger with a topic that contains both Back-end and AI. It is my journey to customize the Natural Language Understanding ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/decorator-pattern/" class="btn btn-outline-primary" prompt="Older"><p>Decorator - A pattern that is ubiquitously used in Python</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> ¬© 2023 <a href="https://twitter.com/username">Tai Le</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/ai/">AI</a> <a class="post-tag" href="/tags/back-end/">Back end</a> <a class="post-tag" href="/tags/database/">Database</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/front-end/">Front end</a> <a class="post-tag" href="/tags/haskell/">Haskell</a> <a class="post-tag" href="/tags/math/">Math</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/tensorflow/">Tensorflow</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://tailtq.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
