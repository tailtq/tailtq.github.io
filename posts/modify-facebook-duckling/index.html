<!DOCTYPE html><html lang="en-US" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Modify Facebook’s Duckling" /><meta name="author" content="Tai Le" /><meta property="og:locale" content="en_US" /><meta name="description" content="It has been a long time since I wrote my last post, which is about the Bridge Pattern, I have been quite busy and my mind has been stuffed with many things lately so I hardly produce any posts, so sorry…" /><meta property="og:description" content="It has been a long time since I wrote my last post, which is about the Bridge Pattern, I have been quite busy and my mind has been stuffed with many things lately so I hardly produce any posts, so sorry…" /><link rel="canonical" href="https://tailtq.github.io/posts/modify-facebook-duckling/" /><meta property="og:url" content="https://tailtq.github.io/posts/modify-facebook-duckling/" /><meta property="og:site_name" content="Tailtq" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-11-04T00:00:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Modify Facebook’s Duckling" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Tai Le" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Tai Le"},"dateModified":"2022-12-05T12:30:15+07:00","datePublished":"2022-11-04T00:00:00+07:00","description":"It has been a long time since I wrote my last post, which is about the Bridge Pattern, I have been quite busy and my mind has been stuffed with many things lately so I hardly produce any posts, so sorry…","headline":"Modify Facebook’s Duckling","mainEntityOfPage":{"@type":"WebPage","@id":"https://tailtq.github.io/posts/modify-facebook-duckling/"},"url":"https://tailtq.github.io/posts/modify-facebook-duckling/"}</script><title>Modify Facebook's Duckling | Tailtq</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Tailtq"><meta name="application-name" content="Tailtq"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-ZB7VQFD7XK"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-ZB7VQFD7XK'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-right"><div id="avatar"> <a href="/" alt="avatar"> <img src="/assets/img/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Tailtq</a></div><div class="site-subtitle">A software developer who enjoys learning, reading, and building things</div></div><hr><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <span>Home</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <span>About me</span> </a><li class="nav-item"> <a href="/interesting-blogs/" class="nav-link"> <span>Interesting blogs</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <span>Archives</span> </a><li class="nav-item"> <a href="https://github.com/tailtq" class="nav-link" target="_blank"> <span>GitHub</span> </a><li class="nav-item}"> <a href="https://www.linkedin.com/in/tai-le-05124a187/" class="nav-link" target="_blank"> <span>Linkedin</span> </a></ul></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Modify Facebook's Duckling</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Modify Facebook's Duckling</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Tai Le </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Nov 4, 2022, 12:00 AM +0700" prep="on" > Nov 4, 2022 <i class="unloaded">2022-11-04T00:00:00+07:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Dec 5, 2022, 12:30 PM +0700" prefix="Updated " > Dec 5, 2022 <i class="unloaded">2022-12-05T12:30:15+07:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1755 words">9 min</span></div></div><div class="post-content"><p>It has been a long time since I wrote my last post, which is about the <a href="posts/how-i-reduced-rasa-testing-time-by-60-80/">Bridge Pattern</a>, I have been quite busy and my mind has been stuffed with many things lately so I hardly produce any posts, so sorry…</p><p>The idea of writing this new blog post popped into my mind spontaneously when I completed one task in my company: adding more patterns to the DateTime parser library. I believe it is a good idea because it would help remind my future self, who is having a hard time with himself, that he can accomplish things, even if they are complicated and require many skills.</p><p>The Facebook library is <a href="https://github.com/facebook/duckling">Duckling</a>, it is a Haskell library that parses text into structured data. Here is an example showing what the engine can do:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c"># From Duckling GitHub repository</span>
<span class="s2">"the first Tuesday of October"</span>
<span class="o">=&gt;</span> <span class="o">{</span><span class="s2">"value"</span>:<span class="s2">"2017-10-03T00:00:00.000-07:00"</span>,<span class="s2">"grain"</span>:<span class="s2">"day"</span><span class="o">}</span>

<span class="s2">"80F"</span>
<span class="o">=&gt;</span> <span class="o">{</span><span class="s2">"value"</span>:80,<span class="s2">"type"</span>:<span class="s2">"value"</span>,<span class="s2">"unit"</span>:<span class="s2">"fahrenheit"</span><span class="o">}</span>
</pre></table></code></div></div><p>In general, the library contains a bunch of Regex patterns and rules that help us classify the category of the free-text (datetime, number, phone numbers), then automatically extract the information from that. Back then, my mission was to add some rules to the library because some messages couldn’t be understood. Below is my approach to solving it.</p><h2 id="1-approach">1. Approach</h2><p>Because the library is written in Haskell, so I needed to learn the language first. At that time, I had two options:</p><ol><li>Learn the whole language and know every syntax and how to set up servers<li>Just learn enough to perform the task</ol><p>From my perspective, I rarely use Haskell after completing the task and I still have other things to learn, so I chose to stick with the second option. Besides, I usually favor the second option for other technologies and it’s perfectly reasonable to call me a hasty or practical guy, but I believe it would be a waste of time to learn something in-depth and eventually throw it away. It is fine to learn the basics and dive in depth later if we need to.</p><p>After learning Haskell, I would clone the source code, build it, and test several functions. Subsequently, I would read it and understand its structure to add the new code in the ways that I want.</p><h2 id="2-implementation">2. Implementation</h2><h3 id="a-haskell">a. Haskell</h3><p>I haven’t delved into functional programming yet but as far as I know, Haskell is the one; we only need to describe what tasks should be done and leave the responsibility to computers to handle them. Subsequently, computers will choose the most effective way to process tasks. The abstracted layers are often complex and require a great understanding of many aspects of Computer Science to work on.</p><p>To grab the syntax of Haskell, I used two resources:</p><ul><li><a href="https://learnxinyminutes.com/docs/haskell/">Learn X in Y minutes</a>: This one summarizes all syntax with clear explanations.<li><a href="https://www.youtube.com/watch?v=02_H3LjqMr8&amp;ab_channel=DerekBanas">Haskell Tutorial</a> by <a href="https://www.youtube.com/c/derekbanas">Derek Banas</a>: This one also walks through Haskell’s syntax, but it allows me to code along and this is how I learn.</ul><p>After using them, I learned plenty of data structures, data types, how to define a function, etc. In conclusion, it took me 6-8 hours to learn the language at the basic level and to set up the run-time environment for Haskell locally.</p><h3 id="b-duckling">b. Duckling</h3><p>Duckling structure is very easy to understand even for a guy having a limited understanding of Haskell like me. That’s why I always imagine guys in FANG or other big corporations are so intelligent, they can write clean and organized code for the community. If the source wasn’t Duckling, I would have experienced a hard time understanding and modifying the code.</p><p>During the journey, I set up the server and called several API requests to ensure it worked fine. Subsequently, in the Extending Duckling part on GitHub, it told me that I only needed to modify 2 files:</p><ol><li><code class="language-plaintext highlighter-rouge">Duckling/&lt;Dimension&gt;/&lt;Lang&gt;/Rules.hs</code><li><code class="language-plaintext highlighter-rouge">Duckling/&lt;Dimension&gt;/&lt;Lang&gt;/Corpus.hs</code></ol><p><strong>Note:</strong></p><ul><li>Dimension here is the category of text, such as Distance, PhoneNumber, Email,…<li>The <code class="language-plaintext highlighter-rouge">Rules.hs</code> file contains the rules and patterns that parse free texts into structured data.<li>The <code class="language-plaintext highlighter-rouge">Corpus.hs</code> file contains the test cases to verify the rules.</ul><p>Therefore, I could skip other non-related parts such as building API using Haskell. Based on the task I needed to do, the dimension is Time and the language is EN (English). Therefore, the files that we need to modify would be available in the <code class="language-plaintext highlighter-rouge">Duckling/Time/EN</code> directory. Note that the country code folders contain the rules respected to each country, such as <code class="language-plaintext highlighter-rouge">Cyber Monday in the US</code> or <code class="language-plaintext highlighter-rouge">Read Across America Day</code>.</p><p>A rule contains 3 parts:</p><ul><li><code class="language-plaintext highlighter-rouge">name</code>: Describe what the rule will catch (an illustration of the pattern).<li><code class="language-plaintext highlighter-rouge">pattern</code>: Specify the underlying pattern for the rule.<li><code class="language-plaintext highlighter-rouge">prod</code>: Receive the pattern’s output and handle the logic of parsing the text.</ul><p>Below are the data types that we need to understand before diving deep into any particular rules:</p><div class="language-haskell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="c1">-- Production: A function that takes a list of tokens, parses and map them into another format, and return the formatted data (one token).</span>
<span class="kr">type</span> <span class="kt">Production</span> <span class="o">=</span> <span class="p">[</span><span class="kt">Token</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="kt">Maybe</span> <span class="kt">Token</span>
<span class="c1">-- Predicate: A function that takes one token and check if its format is valid (check valid day of week, day of month, year, etc...).</span>
<span class="kr">type</span> <span class="kt">Predicate</span> <span class="o">=</span> <span class="kt">Token</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
<span class="c1">-- </span>
<span class="kr">data</span> <span class="kt">PatternItem</span> <span class="o">=</span> <span class="kt">Regex</span> <span class="kt">PCRE</span><span class="o">.</span><span class="kt">Regex</span> <span class="o">|</span> <span class="kt">Predicate</span> <span class="kt">Predicate</span>

<span class="kr">type</span> <span class="kt">Pattern</span> <span class="o">=</span> <span class="p">[</span><span class="kt">PatternItem</span><span class="p">]</span>

<span class="kr">data</span> <span class="kt">Rule</span> <span class="o">=</span> <span class="kt">Rule</span>
  <span class="p">{</span> <span class="n">name</span> <span class="o">::</span> <span class="kt">Text</span>
  <span class="p">,</span> <span class="n">pattern</span> <span class="o">::</span> <span class="kt">Pattern</span>
  <span class="p">,</span> <span class="n">prod</span> <span class="o">::</span> <span class="kt">Production</span>
  <span class="p">}</span>
</pre></table></code></div></div><p>Below is one particular rule, it matches the text having the pattern <code class="language-plaintext highlighter-rouge">this|next &lt;day-of-week&gt;</code> and returns structured data after parsing:</p><div class="language-haskell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c1">-- Describe the data type of the variable</span>
<span class="n">ruleNextDOW</span> <span class="o">::</span> <span class="kt">Rule</span>
<span class="c1">-- Define an object based on data Rule (like an object with respective properties)</span>
<span class="n">ruleNextDOW</span> <span class="o">=</span> <span class="kt">Rule</span>
  <span class="p">{</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"this|next &lt;day-of-week&gt;"</span>
  <span class="p">,</span> <span class="n">pattern</span> <span class="o">=</span>
    <span class="p">[</span> <span class="n">regex</span> <span class="s">"(this|next)"</span>  <span class="c1">-- If the text matches this pattern -&gt; pass</span>
    <span class="p">,</span> <span class="kt">Predicate</span> <span class="n">isADayOfWeek</span>  <span class="c1">-- If the text matches mon, monday, tue, tues, ... -&gt; pass</span>
    <span class="p">]</span>
  <span class="p">,</span> <span class="n">prod</span> <span class="o">=</span> <span class="nf">\</span><span class="kr">case</span>
      <span class="p">(</span>
        <span class="kt">Token</span> <span class="kt">RegexMatch</span> <span class="p">(</span><span class="kt">GroupMatch</span> <span class="p">(</span><span class="n">match</span><span class="o">:</span><span class="kr">_</span><span class="p">))</span><span class="o">:</span>
        <span class="kt">Token</span> <span class="kt">Time</span> <span class="n">dow</span><span class="o">:</span>
        <span class="kr">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kr">do</span>
          <span class="n">td</span> <span class="o">&lt;-</span> <span class="kr">case</span> <span class="kt">Text</span><span class="o">.</span><span class="n">toLower</span> <span class="n">match</span> <span class="kr">of</span>
                  <span class="s">"this"</span> <span class="o">-&gt;</span> <span class="kt">Just</span> <span class="o">$</span> <span class="n">predNth</span> <span class="mi">0</span> <span class="kt">True</span> <span class="n">dow</span>
                  <span class="s">"next"</span> <span class="o">-&gt;</span> <span class="n">intersect</span> <span class="n">dow</span> <span class="o">$</span> <span class="n">cycleNth</span> <span class="kt">TG</span><span class="o">.</span><span class="kt">Week</span> <span class="mi">1</span>
                  <span class="kr">_</span> <span class="o">-&gt;</span> <span class="kt">Nothing</span>
          <span class="n">tt</span> <span class="n">td</span>
      <span class="kr">_</span> <span class="o">-&gt;</span> <span class="kt">Nothing</span>
  <span class="p">}</span>
</pre></table></code></div></div><p>For example, today is Saturday November 19th; if I input <code class="language-plaintext highlighter-rouge">this sunday</code>, I will retrieve <code class="language-plaintext highlighter-rouge">November 20th</code>.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">&gt;&gt;</span> curl <span class="nt">-XPOST</span> http://0.0.0.0:8000/parse <span class="nt">--data</span> <span class="s1">'locale=en_GB&amp;text=this sunday'</span>      
<span class="o">[{</span><span class="s2">"body"</span>:<span class="s2">"this sunday"</span>,<span class="s2">"start"</span>:0,<span class="s2">"value"</span>:<span class="o">{</span><span class="s2">"values"</span>:[<span class="o">{</span><span class="s2">"value"</span>:<span class="s2">"2022-11-20T00:00:00.000-08:00"</span>,<span class="s2">"grain"</span>:<span class="s2">"day"</span>,<span class="s2">"type"</span>:<span class="s2">"value"</span><span class="o">}]</span>,<span class="s2">"value"</span>:<span class="s2">"2022-11-20T00:00:00.000-08:00"</span>,<span class="s2">"grain"</span>:<span class="s2">"day"</span>,<span class="s2">"type"</span>:<span class="s2">"value"</span><span class="o">}</span>,<span class="s2">"end"</span>:11,<span class="s2">"dim"</span>:<span class="s2">"time"</span>,<span class="s2">"latent"</span>:false<span class="o">}]</span>
</pre></table></code></div></div><p>As my little research told me, <code class="language-plaintext highlighter-rouge">\case do</code> syntax allows matching valid text, executing the code block, and ignoring other invalid cases. Note that <code class="language-plaintext highlighter-rouge">:</code> is used to separate the variables in <code class="language-plaintext highlighter-rouge">\case do</code>, <code class="language-plaintext highlighter-rouge">_</code> represents things we don’t use and there must be one after listing all variables. Inside the pattern, I believe that it uses the high-order function concept in functional programming to convert a data type to another:</p><ol><li>First variable: convert objects having the <code class="language-plaintext highlighter-rouge">Token</code> data type to <code class="language-plaintext highlighter-rouge">RegexMatch</code> which can parse into string(s).<li>Second variable: convert objects having the <code class="language-plaintext highlighter-rouge">Token</code> data type to <code class="language-plaintext highlighter-rouge">Time</code>, the converted object can use properties of <code class="language-plaintext highlighter-rouge">TimeData</code> because those two are mapped in <code class="language-plaintext highlighter-rouge">Ducking/Types.hs</code> file.</ol><p>For now, our Sunday is converted into structured data containing multiple Sundays. Subsequently, in the code block, it uses <code class="language-plaintext highlighter-rouge">\case do</code> again for each text. In <code class="language-plaintext highlighter-rouge">this</code> case, firstly call the function <code class="language-plaintext highlighter-rouge">predNth</code> with 3 arguments <code class="language-plaintext highlighter-rouge">0</code>, <code class="language-plaintext highlighter-rouge">True</code>, <code class="language-plaintext highlighter-rouge">dow</code> to select the Sunday in this week; then it retrieves the concrete value from <code class="language-plaintext highlighter-rouge">Maybe</code> (like <code class="language-plaintext highlighter-rouge">Optional</code> in Python) returned from <code class="language-plaintext highlighter-rouge">predNth</code>. In <code class="language-plaintext highlighter-rouge">next</code> case, it simply chooses the intersection between multiple Sundays and the next week’s time.</p><p>Eventually, it converts the final daytime to a token using <code class="language-plaintext highlighter-rouge">tt</code> function. That’s how a rule works.</p><h3 id="c-custom-rules">c. Custom rules</h3><p>And here are the rules that I wrote, I don’t know why Duckling doesn’t support these cases though. I won’t walk you guys through these anymore because they are quite similar to the one above. The key here is to read other rules to understand the <code class="language-plaintext highlighter-rouge">pattern</code> and <code class="language-plaintext highlighter-rouge">prod</code>, then we can implement our own rules.</p><p><strong>Rule 1:</strong> The first one is simply just a day of the week and its date but Ducking assumes the date is the year.</p><div class="language-haskell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="c1">-- Monday 26</span>
<span class="n">ruleDOWDOM</span> <span class="o">::</span> <span class="kt">Rule</span>
<span class="n">ruleDOWDOM</span> <span class="o">=</span> <span class="kt">Rule</span>
  <span class="p">{</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"&lt;day-of-week&gt; &lt;day-of-month&gt; (ordinal or number)"</span>
  <span class="p">,</span> <span class="n">pattern</span> <span class="o">=</span>
    <span class="p">[</span> <span class="kt">Predicate</span> <span class="n">isADayOfWeek</span>
    <span class="p">,</span> <span class="kt">Predicate</span> <span class="n">isDOMValue</span>
    <span class="p">]</span>
  <span class="p">,</span> <span class="n">prod</span> <span class="o">=</span> <span class="nf">\</span><span class="kr">case</span>
      <span class="p">(</span><span class="kt">Token</span> <span class="kt">Time</span> <span class="n">dow</span><span class="o">:</span><span class="n">dom</span><span class="o">:</span><span class="kr">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kr">do</span>
        <span class="n">d</span> <span class="o">&lt;-</span> <span class="n">getIntValue</span> <span class="n">dom</span>
        <span class="kt">Token</span> <span class="kt">Time</span> <span class="o">&lt;$&gt;</span> <span class="n">intersect</span> <span class="n">dow</span> <span class="p">(</span><span class="n">dayOfMonth</span> <span class="n">d</span><span class="p">)</span>
      <span class="kr">_</span> <span class="o">-&gt;</span> <span class="kt">Nothing</span>
  <span class="p">}</span>
</pre></table></code></div></div><p>Test:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">&gt;&gt;</span> curl <span class="nt">-XPOST</span> http://0.0.0.0:8000/parse <span class="nt">--data</span> <span class="s1">'locale=en_GB&amp;text=tues 22'</span>  
<span class="o">[{</span><span class="s2">"body"</span>:<span class="s2">"tues 22"</span>,<span class="s2">"start"</span>:0,<span class="s2">"value"</span>:<span class="o">{</span><span class="s2">"values"</span>:[<span class="o">{</span><span class="s2">"value"</span>:<span class="s2">"2022-11-22T00:00:00.000-08:00"</span>,<span class="s2">"grain"</span>:<span class="s2">"day"</span>,<span class="s2">"type"</span>:<span class="s2">"value"</span><span class="o">}</span>,<span class="o">{</span><span class="s2">"value"</span>:<span class="s2">"2023-08-22T00:00:00.000-07:00"</span>,<span class="s2">"grain"</span>:<span class="s2">"day"</span>,<span class="s2">"type"</span>:<span class="s2">"value"</span><span class="o">}]</span>,<span class="s2">"value"</span>:<span class="s2">"2022-11-22T00:00:00.000-08:00"</span>,<span class="s2">"grain"</span>:<span class="s2">"day"</span>,<span class="s2">"type"</span>:<span class="s2">"value"</span><span class="o">}</span>,<span class="s2">"end"</span>:7,<span class="s2">"dim"</span>:<span class="s2">"time"</span>,<span class="s2">"latent"</span>:false<span class="o">}]</span>
</pre></table></code></div></div><p><strong>Rule 2:</strong> Ducking misrecognizes the number behind <code class="language-plaintext highlighter-rouge">#</code> as a date in a month, so adding another rule is appropriate.</p><div class="language-haskell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="c1">-- #1 Thursday, September 15 at 10:00am</span>
<span class="n">ruleOrderDOWMonthDOMTime</span> <span class="o">::</span> <span class="kt">Rule</span>
<span class="n">ruleOrderDOWMonthDOMTime</span> <span class="o">=</span> <span class="kt">Rule</span>
  <span class="p">{</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"#1 &lt;day-of-week&gt;, &lt;named-month&gt; &lt;day-of-month&gt; (ordinal or number) at hh:mm am|pm"</span>
  <span class="p">,</span> <span class="n">pattern</span> <span class="o">=</span>
    <span class="p">[</span> <span class="n">regex</span> <span class="s">"#?</span><span class="se">\\</span><span class="s">d+.?"</span>
    <span class="p">,</span> <span class="kt">Predicate</span> <span class="n">isADayOfWeek</span>
    <span class="p">,</span> <span class="n">regex</span> <span class="s">",| +"</span>
    <span class="p">,</span> <span class="kt">Predicate</span> <span class="n">isAMonth</span>
    <span class="p">,</span> <span class="kt">Predicate</span> <span class="n">isDOMValue</span>
    <span class="p">,</span> <span class="n">regex</span> <span class="s">"(?:at +)?((?:[01]?</span><span class="se">\\</span><span class="s">d)|(?:2[0-3]))[:.]([0-5]</span><span class="se">\\</span><span class="s">d) ?(?:([ap])</span><span class="se">\\</span><span class="s">.?m?</span><span class="se">\\</span><span class="s">.?)?"</span>
    <span class="p">]</span>
  <span class="p">,</span> <span class="n">prod</span> <span class="o">=</span> <span class="nf">\</span><span class="kr">case</span>
      <span class="p">(</span>
        <span class="kr">_</span><span class="o">:</span>
        <span class="kt">Token</span> <span class="kt">Time</span> <span class="n">dow</span><span class="o">:</span>
        <span class="kr">_</span><span class="o">:</span>
        <span class="kt">Token</span> <span class="kt">Time</span> <span class="n">td</span><span class="o">:</span>
        <span class="n">dom</span><span class="o">:</span>
        <span class="kt">Token</span> <span class="kt">RegexMatch</span> <span class="p">(</span><span class="kt">GroupMatch</span> <span class="p">(</span><span class="n">hh</span><span class="o">:</span><span class="n">mm</span><span class="o">:</span><span class="n">ap</span><span class="o">:</span><span class="kr">_</span><span class="p">))</span><span class="o">:</span>
        <span class="kr">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kr">do</span>
        <span class="n">d</span> <span class="o">&lt;-</span> <span class="n">getIntValue</span> <span class="n">dom</span>
        <span class="n">h</span> <span class="o">&lt;-</span> <span class="n">parseInt</span> <span class="n">hh</span>
        <span class="n">m</span> <span class="o">&lt;-</span> <span class="n">parseInt</span> <span class="n">mm</span>

        <span class="n">hm</span> <span class="o">&lt;-</span> <span class="kr">case</span> <span class="kt">Text</span><span class="o">.</span><span class="n">toLower</span> <span class="n">ap</span> <span class="kr">of</span>
          <span class="s">"a"</span> <span class="o">-&gt;</span> <span class="kt">Just</span> <span class="o">$</span> <span class="n">timeOfDayAMPM</span> <span class="kt">True</span> <span class="p">(</span><span class="n">hourMinute</span> <span class="kt">True</span> <span class="n">h</span> <span class="n">m</span><span class="p">)</span>
          <span class="s">"p"</span> <span class="o">-&gt;</span> <span class="kt">Just</span> <span class="o">$</span> <span class="n">timeOfDayAMPM</span> <span class="kt">False</span> <span class="p">(</span><span class="n">hourMinute</span> <span class="kt">True</span> <span class="n">h</span> <span class="n">m</span><span class="p">)</span>
          <span class="kr">_</span> <span class="o">-&gt;</span> <span class="kt">Just</span> <span class="o">$</span> <span class="n">hourMinute</span> <span class="kt">False</span> <span class="n">h</span> <span class="n">m</span>
        <span class="n">dowHm</span> <span class="o">&lt;-</span> <span class="n">intersect</span> <span class="n">dow</span> <span class="n">hm</span>
        <span class="n">domDowHm</span> <span class="o">&lt;-</span> <span class="n">intersect</span> <span class="p">(</span><span class="n">dayOfMonth</span> <span class="n">d</span><span class="p">)</span> <span class="n">dowHm</span>
        <span class="kt">Token</span> <span class="kt">Time</span> <span class="o">&lt;$&gt;</span> <span class="n">intersect</span> <span class="n">td</span> <span class="n">domDowHm</span>
      <span class="kr">_</span> <span class="o">-&gt;</span> <span class="kt">Nothing</span>
  <span class="p">}</span>
</pre></table></code></div></div><p>Test:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">&gt;&gt;</span> curl <span class="nt">-XPOST</span> http://0.0.0.0:8000/parse <span class="nt">--data</span> <span class="s1">'locale=en_GB&amp;text=#1. Thur September 15 13:30'</span>  
<span class="o">[{</span><span class="s2">"body"</span>:<span class="s2">"#1. Thur September 15 13:30"</span>,<span class="s2">"start"</span>:0,<span class="s2">"value"</span>:<span class="o">{</span><span class="s2">"values"</span>:[<span class="o">{</span><span class="s2">"value"</span>:<span class="s2">"2022-09-15T13:30:00.000-07:00"</span>,<span class="s2">"grain"</span>:<span class="s2">"minute"</span>,<span class="s2">"type"</span>:<span class="s2">"value"</span><span class="o">}</span>,<span class="o">{</span><span class="s2">"value"</span>:<span class="s2">"2016-09-15T13:30:00.000-07:00"</span>,<span class="s2">"grain"</span>:<span class="s2">"minute"</span>,<span class="s2">"type"</span>:<span class="s2">"value"</span><span class="o">}]</span>,<span class="s2">"value"</span>:<span class="s2">"2022-09-15T13:30:00.000-07:00"</span>,<span class="s2">"grain"</span>:<span class="s2">"minute"</span>,<span class="s2">"type"</span>:<span class="s2">"value"</span><span class="o">}</span>,<span class="s2">"end"</span>:27,<span class="s2">"dim"</span>:<span class="s2">"time"</span>,<span class="s2">"latent"</span>:false<span class="o">}]</span>
</pre></table></code></div></div><h2 id="3-conclusion">3. Conclusion</h2><p>Recently, I have modified quite a lot libraries to add more features and improve performance. Luckily, the approach I used is time-effective and doesn’t require a huge effort. It has some drawbacks which are not understanding the technology deeply and sometimes wearing away our patience. In this case, even though I performed the task pretty well, I don’t have the knowledge to write a simple function, let alone building servers, … Therefore, if you need to use any technology in the long-term, consider delving in-depth.</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/haskell/" class="post-tag no-text-decoration" >Haskell</a> <a href="/tags/back-end/" class="post-tag no-text-decoration" >Back-end</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Modify Facebook's Duckling - Tailtq&url=https://tailtq.github.io/posts/modify-facebook-duckling/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Modify Facebook's Duckling - Tailtq&u=https://tailtq.github.io/posts/modify-facebook-duckling/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Modify Facebook's Duckling - Tailtq&url=https://tailtq.github.io/posts/modify-facebook-duckling/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/asynchronous-programming/">Asynchronous Programming</a><li><a href="/posts/streamlit-a-fast-way-to-build-web-applications/">Streamlit - A Fast Way to Build Web Applications</a><li><a href="/posts/modify-facebook-duckling/">Modify Facebook's Duckling</a><li><a href="/posts/tensorflow-with-amd-ubuntu/">Use Tensorflow with AMD GPU on Ubuntu</a><li><a href="/posts/how-i-reduced-rasa-testing-time-by-60-80/">How I reduced RASA testing time by 60-80%</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/ai/">AI</a> <a class="post-tag" href="/tags/back-end/">Back-end</a> <a class="post-tag" href="/tags/database/">Database</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/front-end/">Front-end</a> <a class="post-tag" href="/tags/haskell/">Haskell</a> <a class="post-tag" href="/tags/math/">Math</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/tensorflow/">Tensorflow</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/mysql-explain-json/"><div class="card-body"> <span class="timeago small" > Dec 25, 2021 <i class="unloaded">2021-12-25T00:00:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MySQL Explain JSON</h3><div class="text-muted small"><p> Asides from the tasks that my team is working on in my company, I am also supporting a software architect to find some solutions to optimize the slow SQL queries in several functionalities. And now...</p></div></div></a></div><div class="card"> <a href="/posts/multithreading-vs-multiprocessing/"><div class="card-body"> <span class="timeago small" > Apr 2, 2022 <i class="unloaded">2022-04-02T00:00:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Multi-threading vs Multi-processing</h3><div class="text-muted small"><p> At some points, we encounter some problems that make our applications tremendously slow. It could be the amount of computation is large, or accessing multiple resources at the time, or too many tas...</p></div></div></a></div><div class="card"> <a href="/posts/caching/"><div class="card-body"> <span class="timeago small" > May 1, 2022 <i class="unloaded">2022-05-01T00:00:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Caching</h3><div class="text-muted small"><p> With an anxious feeling at this moment, I have decided to write a blog article to relieve that feeling. Again, it is all about summarizing things that I have recently worked on, this time is some c...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/bridge-pattern/" class="btn btn-outline-primary" prompt="Older"><p>Bridge - A pattern that every developer should know</p></a> <a href="/posts/decorator-pattern/" class="btn btn-outline-primary" prompt="Newer"><p>Decorator - A pattern that is ubiquitously used in Python</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">Tai Le</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/ai/">AI</a> <a class="post-tag" href="/tags/back-end/">Back end</a> <a class="post-tag" href="/tags/database/">Database</a> <a class="post-tag" href="/tags/devops/">DevOps</a> <a class="post-tag" href="/tags/front-end/">Front end</a> <a class="post-tag" href="/tags/haskell/">Haskell</a> <a class="post-tag" href="/tags/math/">Math</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/tensorflow/">Tensorflow</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://tailtq.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
